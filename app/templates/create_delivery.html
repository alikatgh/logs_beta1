{% extends 'base.html' %}

{% block content %}
  <header class="text-center">
      <h1>Create Delivery</h1>
  </header>
  <form method="POST" action="{{ url_for('main.create_delivery') }}" class="mt-4" id="delivery-form">
    <div class="form-group">
      <label for="delivery_date">Delivery Date</label>
      <input type="date" class="form-control" id="delivery_date" name="delivery_date" required>
    </div>
    <div class="form-group">
      <label for="supermarket_id">Supermarket</label>
      <select class="form-control" id="supermarket_id" name="supermarket_id" required>
        <option value="" disabled selected>Choose Supermarket</option>
        {% for supermarket in supermarkets %}
          <option value="{{ supermarket.id }}">{{ supermarket.name }}</option>
        {% endfor %}
      </select>
    </div>
    <h3>Products</h3>
    <table class="table table-striped table-hover" id="products-table">
      <thead class="thead-dark">
        <tr>
          <th>Product</th>
          <th>Quantity</th>
          <th>Price</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody>
        <tr class="product-row">
          <td>
            <select class="form-control product-select" name="product_id[]" required>
              <option value="" disabled selected>Choose Product</option>
              {% for product in products %}
                <option value="{{ product.id }}" data-price="{{ product.price }}">{{ product.name }}</option>
              {% endfor %}
            </select>
          </td>
          <td><input type="number" class="form-control quantity-input" name="quantity[]" placeholder="Quantity" required></td>
          <td><input type="number" step="0.01" class="form-control price-input" name="price[]" placeholder="Price" readonly required></td>
          <td><button type="button" class="btn btn-danger remove-row">Remove</button></td>
        </tr>
      </tbody>
    </table>
    <div class="text-right">
      <button type="button" class="btn btn-primary" id="add-row">Add Product</button>
    </div>
    <div class="text-center mt-4">
      <button type="submit" class="btn btn-success btn-lg">Create Delivery</button>
    </div>
  </form>

  <script>
    // Function to create a clean product row
    function createProductRow() {
      const newRow = document.createElement('tr');
      newRow.className = 'product-row';
      newRow.innerHTML = `
        <td>
          <select class="form-control product-select" name="product_id[]" required>
            <option value="" disabled selected>Choose Product</option>
            {% for product in products %}
                <option value="{{ product.id }}" data-price="{{ product.price }}">{{ product.name }}</option>
            {% endfor %}
          </select>
        </td>
        <td><input type="number" class="form-control quantity-input" name="quantity[]" placeholder="Quantity" required></td>
        <td><input type="number" step="0.01" class="form-control price-input" name="price[]" placeholder="Price" readonly required></td>
        <td><button type="button" class="btn btn-danger remove-row">Remove</button></td>
      `;
      return newRow;
    }

    document.getElementById('add-row').addEventListener('click', function () {
        const table = document.getElementById('products-table').getElementsByTagName('tbody')[0];
        const newRow = createProductRow();
        table.appendChild(newRow);
    });

    document.addEventListener('click', function (e) {
        if (e.target && e.target.classList.contains('remove-row')) {
            const row = e.target.closest('tr');
            const table = row.closest('tbody');
            if (table.rows.length > 1) {
                row.remove();
            }
        }
    });

    document.getElementById('delivery-form').addEventListener('submit', function (e) {
        const table = document.getElementById('products-table').getElementsByTagName('tbody')[0];
        const rows = table.querySelectorAll('tr');
        let emptyRows = false;

        rows.forEach(row => {
            const productSelect = row.querySelector('.product-select');
            const quantityInput = row.querySelector('.quantity-input');
            const priceInput = row.querySelector('.price-input');
            
            if (productSelect.value === "" || quantityInput.value === "" || priceInput.value === "") {
                emptyRows = true;
                row.remove();
            }
        });

        if (emptyRows) {
            e.preventDefault();
            alert('Please fill out all product fields or remove empty rows.');
        }
    });

    // Update price input based on selected product
    document.addEventListener('change', function (e) {
        if (e.target && e.target.classList.contains('product-select')) {
            const selectedOption = e.target.options[e.target.selectedIndex];
            const priceInput = e.target.closest('tr').querySelector('.price-input');
            priceInput.value = selectedOption.getAttribute('data-price');
        }
    });
  </script>
{% endblock %}
